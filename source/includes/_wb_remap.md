## Доступ по токену к JSON API 1.2

### Базовая информация

Токен для доступа к JSON API 1.2 передается вендору при активации приложения через Vendor API в момент установки или 
возобновления приложения. Время жизни токена не ограничено.

Токен аннулируется при удалении и приостановке приложения. На момент деактивации приложения через Vendor API токен уже 
нерабочий (аннулирован).

Токен при доступе к JSON API 1.2 следует передавать как [Bearer-токен](https://tools.ietf.org/html/rfc6750#section-2.1),
 а именно в виде заголовка HTTP-запроса:
 
 ```text
Authorization: Bearer <access_token>
 ```

Пример:

```text
Authorization: Bearer 6ab89be1ae6ff147755625ee8da948e42612233b
```

#### Диаграмма последовательности предоставления доступа при подключении приложения

![useful image](diag_install.png)

#### Диаграмма последовательности отзыва доступа при отключении приложения

![useful image](diag_uninstall.png)


### Vendor API

Vendor API предназначено для взаимодействия Маркетплейса с системами вендоров касательно процессов, происходящих в 
рамках функционирования Маркетплейса.

На текущий момент Vendor API включает в себя следующие функции:

+ Активацию и деактивацию приложений на аккаунте
+ Получение контекста пользователя приложения


#### Процесс активации приложения на аккаунте

В общем виде процесс активации приложения выглядит так:

1. Пользователь МоегоСклада нажимает кнопку “Установить” приложение.
    + **Для платных приложений возможно возобновление в случаях:** 
        + Пользователь, на аккаунте которого есть приостановленные приложения, оплачивает подписку с опцией "Платное 
        приложение"
        + Пользователь удаляет работающее платное приложение, после чего нажимает кнопку "Активировать" у 
        приостановленного приложения.
2. Маркетплейс делает HTTP PUT запрос на сервер вендора, в том числе передавая и токен доступа к JSON API (если в 
дескрипторе приложения таковой доступ запрашивается). При этом доступ по переданному токену уже работает.
3. Сервер вендора, в рамках допустимого тайм-аута, отвечает на запрос одним из статусов в теле ответа:
    + **Activating** - этот статус предназначен для асинхронной активации на стороне вендора (то есть если в рамках 
    допустимого тайм-аута обработки HTTP PUT запроса не получается активировать приложение - например, для активации 
    приложения требуется несколько минут). Далее вендор должен оповестить МойСклад через эндпоинт “Обратного вызова 
    изменения статуса приложения на аккаунте” о завершении активации приложения статусом **Activated** или о том, что 
    приложению требуется настройка статусом **SettingsRequired**.
    + **SettingsRequired** - таким статусом вендор сообщает МоемуСкладу, что приложению требуется настройка пользователем 
    (через iframe-часть приложения). После того, как пользователь настроит приложение, вендор должен оповестить 
    МойСклад через эндпоинт “Обратного вызова изменения статуса приложения на аккаунте” об активации приложения, 
    передав статус **Activated**.
    + **Activated** - этот статус означает, что приложение сразу полностью активировано и уже заработало.

#### Диаграмма деятельности активации приложения

![useful image](diag_activate.png)

#### Процесс деактивации приложения на аккаунте

Процесс деактивации приложения существенно проще процесса активации:

1. Пользователь МоегоСклада нажимает кнопку “Удалить” в карточке приложения.
    + **Для платных приложений возможна приостановка в случаях:** 
        + У пользователя, на аккаунте которого есть установленные платные приложения, кончается подписка.
        + Пользователь, на аккаунте которого есть установленные платные приложения, оплачивает подписку с количеством 
        опций "Платное приложение" меньше, чем установлено платных приложений.        

2. Маркетплейс аннулирует доступ по токену (если таковой был выдан) и выполняет HTTP DELETE запрос к серверу вендора. 
То есть на момент получения вендором оповещения по деактивации доступ по токену уже не работает.

#### Диаграмма деятельности деактивации приложения

![useful image](diag_deactivate.png)
 
### Работа с вебхуками

Если ваше приложение может создать вебхук(-и) на аккаунте пользователя, то нужно иметь в виду следующее поведение:

* Вебхуки доступны только на пробном и платных тарифах
* Перед процессом удаления приложения, инициированного пользователем, МойСклад удалит все созданные приложением вебхуки.
* Перед процессом приостановки приложения (для платных приложений) вебхуки будут отключены, а после возобновления - 
включены.

Подробную информацию о работе с вебхуками можно получить по ссылке
[https://dev.moysklad.ru/workbook/api/remap/1.1/ru/webhooks.html](https://dev.moysklad.ru/workbook/api/remap/1.1/ru/webhooks.html) 

### Особенности доступа к некоторым функциям JSON API 1.2

На данный момент для приложений существует ряд ограничений в работе со следующими сущностями JSON API 1.2:

+ приложение не может быть автором Задач [https://dev.moysklad.ru/doc/api/remap/1.2/dictionaries/#suschnosti-zadacha](https://dev.moysklad.ru/doc/api/remap/1.2/dictionaries/#suschnosti-zadacha)
+ приложение не может работать с Событиями Контрагентов [https://dev.moysklad.ru/doc/api/remap/1.2/dictionaries/#suschnosti-kontragent-sobytiq-kontragenta](https://dev.moysklad.ru/doc/api/remap/1.2/dictionaries/#suschnosti-kontragent-sobytiq-kontragenta)
+ приложение не может использовать Шаблоны документов [https://moysklad.github.io/api-remap-1.2-doc/api/remap/1.2/ru/documents/#dokumenty-obschie-swedeniq-shablony-dokumentow](https://moysklad.github.io/api-remap-1.2-doc/api/remap/1.2/ru/documents/#dokumenty-obschie-swedeniq-shablony-dokumentow)
